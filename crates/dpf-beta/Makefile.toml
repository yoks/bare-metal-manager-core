# Makefile for carbide-dpf-beta
# Refreshes committed CRD YAML inputs used by build.rs generation

[config]
default_to_workspace = false

[env]
DOCA_REPO_URL = "https://github.com/NVIDIA/doca-platform.git"
DOCA_BRANCH = "v25.10.1"
DOCA_CLONE_DIR = "${CARGO_MAKE_WORKING_DIRECTORY}/doca-platform"
CRD_SOURCE_PATH = "${DOCA_CLONE_DIR}/deploy/charts/dpf-operator/templates/crds"
CRD_DEST_PATH = "${CARGO_MAKE_WORKING_DIRECTORY}/crds"

[tasks.clone-doca]
description = "Clone NVIDIA doca-platform repository"
script = '''
if [ -d "${DOCA_CLONE_DIR}" ]; then
    echo "doca-platform already exists, skipping clone"
else
    echo "Cloning NVIDIA doca-platform repository..."
    git clone --depth 1 --branch ${DOCA_BRANCH} ${DOCA_REPO_URL} "${DOCA_CLONE_DIR}"
    echo "Repository cloned"
fi
'''

[tasks.refresh-crds]
description = "Refresh committed CRD YAML files from NVIDIA DOCA Platform"
dependencies = ["clone-doca"]
script = '''
mkdir -p "${CRD_DEST_PATH}"
rm -f "${CRD_DEST_PATH}"/*.yaml
cp "${CRD_SOURCE_PATH}"/*.yaml "${CRD_DEST_PATH}/"
echo "CRD YAML files refreshed"
'''

[tasks.verify]
description = "Verify that build.rs generation compiles"
dependencies = ["refresh-crds"]
command = "cargo"
args = ["check"]

[tasks.generate]
description = "Refresh committed CRDs and verify build.rs generation"
dependencies = ["refresh-crds", "verify"]

[tasks.clean-generated]
description = "Remove committed CRD YAML files"
script = '''
rm -f "${CRD_DEST_PATH}"/*.yaml
echo "Committed CRD YAML files removed"
'''
